<?php
/**
 * @var \Laminas\View\Renderer\PhpRenderer $this
 * @var \Omeka\Api\Representation\SiteRepresentation $site
 * @var \Omeka\Api\Representation\ItemRepresentation $resource
 * @var \Omeka\Entity\User $user
 * @var int $selectionId
 * @var array $selections
 * @var array $records
 * @var bool $isGuestActive
 * @var bool $isSession
 */

// This template display a simple list of the current selection,
// unlike the full hierarchical list of selection-browse.

$plugins = $this->getHelperPluginManager();
$url = $plugins->get('url');
$translate = $plugins->get('translate');
$siteSetting = $plugins->get('siteSetting');
$escapeAttr = $plugins->get('escapeHtmlAttr');
$bulkExport = $plugins->has('bulkExport') ? $plugins->get('bulkExport') : null;

$currentRecords = $records[$selectionId] ?? [];

$deleteText = $escapeAttr($translate('Remove from selection')); // @translate
?>

<details class="selection-list selection-details" <?= $siteSetting('selection_resource_show_open_list', true) ? 'open="open"' : '' ?>>
    <summary><h4><?= $translate('Selected resources') // @translate ?></h4></summary>

    <ul class="selection-resources" data-text-delete="<?= $deleteText ?>">
        <?php foreach ($currentRecords as $resourceId => $record): ?>
        <li data-id="<?= $resourceId ?>">
            <a href="<?= $record['url'] ?>"><?= $record['heading'] ?></a>
            <span class="selection-delete" data-id="<?= $resourceId ?>" data-url="<?= $record['url_remove'] ?>" title="<?= $deleteText ?>" aria-label="<?= $deleteText ?>"></span>
        </li>
        <?php endforeach; ?>
    </ul>

    <p class="selection-empty<?= count($currentRecords) ? '' : ' active' ?>"><?= $translate('No selection') // @translate ?></p>

    <?php
    if ($currentRecords && $bulkExport) { // Does not support mixed types for now.
        $recordsByType = array_column($currentRecords, 'type', 'id');
        $countsByType = array_count_values($recordsByType);
        if (count($countsByType) === 1) {
            echo $bulkExport(array_keys($currentRecords), ['resourceType' => key($countsByType)]);
        } else {
            foreach (array_keys($countsByType) as $type) {
                echo $bulkExport(array_keys($currentRecords, $type), ['resourceType' => $type]);
            }
        }
    }
    ?>
</details>
